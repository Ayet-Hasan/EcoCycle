<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collector Profile</title>
    <link rel="stylesheet" href="collector.css">
</head>

<body>
    <div class="container">
        <!-- Collector Profile Section -->
        <div class="profile-wrapper">
            <h2>Collector Profile</h2>
            <div class="profile-content">
                <!-- Collector Information -->
                <div class="collector-info">
                    <h3 id="collector-name">Welcome, [Collector Name]</h3>
                </div>

                <!-- Agent List and Plastic Submission Form -->
                <div class="agent-selection">
                    <h4>Select Agent to Submit Plastic</h4>
                    <select id="agent-list">
                        <!-- Agent list will be dynamically populated -->
                    </select>

                    <label for="plastic-amount">Amount of Plastic (kg):</label>
                    <input type="number" id="plastic-amount" placeholder="Enter amount" min="0" step="0.1">

                    <button id="submit-plastic-btn">Submit to Agent</button>
                </div>

                <!-- Reward Section -->
                <div class="reward-section">
                    <h4>Rewards</h4>
                    <p id="reward-points">Rewards: 0 Points</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fetching user data from localStorage (after login)
        document.addEventListener('DOMContentLoaded', async () => {
            const user = JSON.parse(localStorage.getItem('user'));
            console.log(user);
            // if (!user || !user.email) {
            //     alert('You are not logged in!');
            //     window.location.href = 'login.html'; // Redirect to login page
            //     return;
            // }

            // const collectorEmail = user.email;
            document.getElementById('collector-name').textContent = `Welcome, ${user.name}`;

    //         try {
    //     // Fetch user data from the server using email
    //     const response = await fetch('http://localhost:5501/getLoggedInUser', {
    //         method: 'GET',
    //         credentials: 'include', // Include session cookies
    //     });

    //     if (!response.ok) {
    //         throw new Error('Failed to fetch user data. Please log in again.');
    //     }

    //     const user = await response.json();

    //     if (!user || !user.email) {
    //         alert('You are not logged in!');
    //         window.location.href = 'login.html'; // Redirect to login page
    //         return;
    //     }

    //     // Display the collector's name
    //     document.getElementById('collector-name').textContent = `Welcome, ${user.name}`;
    // } catch (error) {
    //     console.error('Error fetching user data:', error);
    //     alert('An error occurred. Please log in again.');
    //     window.location.href = 'login.html'; // Redirect to login page
    // }

            try {
                // Fetching agent list
                const agentResponse = await fetch('http://localhost:5501/agents');
                if (!agentResponse.ok) {
                    throw new Error('Failed to fetch agents');
                }

                const agentData = await agentResponse.json();
                const agentList = document.getElementById('agent-list');

                agentData.agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = agent.name;
                    agentList.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching agents:', error);
                alert('Error loading agents. Please try again.');
            }

            // Handle Plastic Submission
            const submitPlasticBtn = document.getElementById('submit-plastic-btn');
            const rewardPoints = document.getElementById('reward-points');
            let points = 0;

            submitPlasticBtn.addEventListener('click', async () => {
                const plasticAmount = document.getElementById('plastic-amount').value;
                const agentId = document.getElementById('agent-list').value;

                if (plasticAmount > 0 && agentId) {
                    try {
                        const response = await fetch('http://localhost:5501/submitPlastic', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                collectorId,
                                agentId,
                                plasticAmount
                            }),
                        });

                        if (!response.ok) {
                            throw new Error('Failed to submit plastic');
                        }

                        const result = await response.json();
                        alert(`Plastic submitted to Agent. Reward Points: ${result.rewardPoints}`);
                        points += result.rewardPoints;
                        rewardPoints.textContent = `Rewards: ${points} Points`;

                    } catch (error) {
                        console.error('Error submitting plastic:', error);
                        alert('Error submitting plastic. Please try again.');
                    }
                } else {
                    alert('Please enter valid data.');
                }
            });
        });
    </script>
</body>

</html>